
name: build-ios-ipa
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Ensure clean xcodeproj
        run: rm -rf MLCServerApp.xcodeproj

      - name: Install tools (brew)
        run: |
          brew update
          brew install xcodegen git-lfs cmake ninja
          git lfs install

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mlc-llm prebuilt wheels
        run: |
          python -m pip install --upgrade pip
          python -m pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu

      - name: Clone MLC source (with submodules)
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/External/mlc-llm
        run: |
          set -euxo pipefail
          mkdir -p External
          git clone --depth=1 --recurse-submodules https://github.com/mlc-ai/mlc-llm.git "$MLC_LLM_SOURCE_DIR"
          git -C "$MLC_LLM_SOURCE_DIR" submodule update --init --recursive
          # Clean CMake cache to ensure patches are applied correctly
          rm -rf "$MLC_LLM_SOURCE_DIR/build" 2>/dev/null || true

      - name: Apply MLC patches
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/External/mlc-llm
        run: |
          python3 << 'EOF'
          import pathlib
          import re
          
          root = pathlib.Path("${{ env.MLC_LLM_SOURCE_DIR }}")
          
          # Patch 1: cmake_minimum_required 범위 확장
          cmake_patch_files = [
              root / "3rdparty/tokenizers-cpp/CMakeLists.txt",
              root / "3rdparty/tokenizers-cpp/msgpack/CMakeLists.txt",
              root / "3rdparty/tokenizers-cpp/sentencepiece/src/CMakeLists.txt",
          ]
          
          cmake_pattern = re.compile(r"cmake_minimum_required\s*\(\s*VERSION\s*[0-9.]+\s*\)", re.IGNORECASE)
          
          for f in cmake_patch_files:
              if f.exists():
                  content = f.read_text()
                  new_content = cmake_pattern.sub("cmake_minimum_required(VERSION 3.5...3.27)", content, count=1)
                  if content != new_content:
                      f.write_text(new_content)
                      print(f"✓ Patched: {f}")
          
          # Patch 2: prepare_libs.sh 정책 플래그
          prepare_libs = root / "ios/prepare_libs.sh"
          if prepare_libs.exists():
              content = prepare_libs.read_text()
              pattern = re.compile(r"(cmake\s+[^\n]*?)(\n)", re.MULTILINE)
              def repl(match):
                  line = match.group(1)
                  if "-DCMAKE_POLICY_VERSION_MINIMUM" in line:
                      return match.group(0)
                  return f"{line} -DCMAKE_POLICY_VERSION_MINIMUM=3.5{match.group(2)}"
              new_content = pattern.sub(repl, content, count=1)
              if content != new_content:
                  prepare_libs.write_text(new_content)
                  print(f"✓ Patched: {prepare_libs}")
          
          # Patch 3: libunwind 제거
          unwind_pattern = re.compile(r"(\s)-lunwind(?=\b)")
          unwind_word_pattern = re.compile(r"(\s)unwind(?=[\s\)\"])")
          
          for f in cmake_patch_files:
              if f.exists():
                  content = f.read_text()
                  new_content = unwind_pattern.sub(r"\1", content)
                  new_content = unwind_word_pattern.sub(r"\1", new_content)
                  if content != new_content:
                      f.write_text(new_content)
                      print(f"✓ Patched (libunwind removed): {f}")
          EOF

      - name: Package MLC assets
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/External/mlc-llm
        run: |
          python -m mlc_llm package \
            --package-config mlc-package-config.json \
            --output dist \
            --mlc-llm-source-dir "$MLC_LLM_SOURCE_DIR"

      - name: Generate Xcode project via XcodeGen
        run: |
          xcodegen generate
          ls -la



      - name: Resolve Packages
        run: |
          xcodebuild -resolvePackageDependencies -project MLCServerApp.xcodeproj || true

      - name: Archive (iphoneos, no code sign)
        run: |
          xcodebuild \
            -project MLCServerApp.xcodeproj \
            -scheme MLCServerApp \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            IPHONEOS_DEPLOYMENT_TARGET=18.5 \
            OTHER_LDFLAGS='$(inherited) -lc++'


      - name: Create unsigned IPA (manual zip)
        run: |
          set -euo pipefail

          APP_PATH="build/App.xcarchive/Products/Applications/MLCServerApp.app"
          IPA_NAME="MLCServerApp-unsigned.ipa"
          WORK_DIR="build/manual-ipa"
          PAYLOAD_DIR="$WORK_DIR/Payload"
          EXPORT_DIR="build/export"

          rm -rf "$WORK_DIR"
          mkdir -p "$PAYLOAD_DIR"
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"

          (cd "$WORK_DIR" && /usr/bin/zip -qry "$IPA_NAME" Payload)

          mkdir -p "$EXPORT_DIR"
          mv "$WORK_DIR/$IPA_NAME" "$EXPORT_DIR/"
          rm -rf "$WORK_DIR"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: MLCServerApp-unsigned
          path: build/export/*.ipa
