
name: build-ios-ipa
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Ensure clean xcodeproj
        run: rm -rf MLCServerApp.xcodeproj

      - name: Install tools (brew)
        run: |
          brew update
          brew install xcodegen git-lfs cmake ninja
          git lfs install

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mlc-llm prebuilt wheels
        run: |
          python -m pip install --upgrade pip
          python -m pip install --pre -U -f https://mlc.ai/wheels \
            mlc-llm-nightly-cpu mlc-ai-nightly-cpu
          echo "== mlc_llm check =="
          python -c "import mlc_llm, sys; print('mlc_llm:', mlc_llm.__file__); print(sys.version)"

      - name: Clone MLC source (with submodules)
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/External/mlc-llm
        run: |
          set -euxo pipefail
          mkdir -p External
          git clone --depth=1 --recurse-submodules https://github.com/mlc-ai/mlc-llm.git "$MLC_LLM_SOURCE_DIR"
          git -C "$MLC_LLM_SOURCE_DIR" submodule update --init --recursive

      - name: Package MLC assets
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/External/mlc-llm
        run: |
          set -euxo pipefail
          bash Scripts/prepare_mlc_assets.sh
          echo "== DIST CONTENTS =="
          find dist -maxdepth 2 -type f | sort

      - name: Generate Xcode project via XcodeGen
        run: |
          xcodegen generate
          ls -la



      - name: Resolve Packages
        run: |
          xcodebuild -resolvePackageDependencies -project MLCServerApp.xcodeproj || true

      - name: Archive (iphoneos, no code sign)
        run: |
          xcodebuild \
            -project MLCServerApp.xcodeproj \
            -scheme MLCServerApp \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            IPHONEOS_DEPLOYMENT_TARGET=18.5 \
            OTHER_LDFLAGS='$(inherited) -lc++'


      - name: Create unsigned IPA (manual zip)
        run: |
          set -euo pipefail

          APP_PATH="build/App.xcarchive/Products/Applications/MLCServerApp.app"
          IPA_NAME="MLCServerApp-unsigned.ipa"
          WORK_DIR="build/manual-ipa"
          PAYLOAD_DIR="$WORK_DIR/Payload"
          EXPORT_DIR="build/export"

          rm -rf "$WORK_DIR"
          mkdir -p "$PAYLOAD_DIR"
          cp -R "$APP_PATH" "$PAYLOAD_DIR/"

          (cd "$WORK_DIR" && /usr/bin/zip -qry "$IPA_NAME" Payload)

          mkdir -p "$EXPORT_DIR"
          mv "$WORK_DIR/$IPA_NAME" "$EXPORT_DIR/"
          rm -rf "$WORK_DIR"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: MLCServerApp-unsigned
          path: build/export/*.ipa
