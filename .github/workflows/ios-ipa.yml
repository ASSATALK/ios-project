name: Build unsigned iOS LLM IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          pod repo update

      - name: Pod install
        working-directory: ios
        run: |
          pod install

      - name: Detect Xcode scheme automatically
        id: detect_scheme
        working-directory: ios
        run: |
          set -euo pipefail
          # InferenceExample.xcworkspace 안의 첫 번째 Scheme 이름 추출
          SCHEME=$(xcodebuild -list -workspace InferenceExample.xcworkspace \
            | sed -n '/Schemes:/,$p' | sed -n '2p' | xargs)
          echo "Detected scheme: $SCHEME"
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Build archive (unsigned)
        working-directory: ios
        run: |
          set -euo pipefail
          echo "Using scheme: $SCHEME"

          xcodebuild \
            -workspace InferenceExample.xcworkspace \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Create unsigned IPA
        working-directory: ios
        run: |
          set -euo pipefail
          APP_NAME="$SCHEME"
          APP_PATH="build/App.xcarchive/Products/Applications/${APP_NAME}.app"
          IPA_NAME="${APP_NAME}-unsigned"

          if [ ! -d "$APP_PATH" ]; then
            echo "❌ App path not found: $APP_PATH"
            ls -R build || true
            exit 1
          fi

          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          zip -r "$IPA_NAME.ipa" Payload

          echo "Created IPA: $IPA_NAME.ipa"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-llm-unsigned-ipa
          path: ios/*.ipa
