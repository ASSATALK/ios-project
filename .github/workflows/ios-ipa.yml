name: Build unsigned iOS LLM IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          pod repo update

      - name: Pod install
        working-directory: ios
        run: |
          pod install

      - name: Patch CocoaPods frameworks script (disable -u)
        working-directory: ios
        run: |
          set -euo pipefail
          FRAMEWORKS_SCRIPT="Pods/Target Support Files/Pods-InferenceExample/Pods-InferenceExample-frameworks.sh"
          echo "Patching $FRAMEWORKS_SCRIPT"
          sed -i '' 's/set -eu/set -e/g' "$FRAMEWORKS_SCRIPT" || true
          sed -i '' 's/set -u//g' "$FRAMEWORKS_SCRIPT" || true
          echo "Patched:"
          head -n 10 "$FRAMEWORKS_SCRIPT"

      - name: Patch CocoaPods Embed Frameworks script to no-op
        working-directory: ios
        run: |
          set -euo pipefail
          SCRIPT_PATH="Pods/Target Support Files/Pods-InferenceExample/Pods-InferenceExample-frameworks.sh"
          echo "Overriding $SCRIPT_PATH with no-op script"

          cat > "$SCRIPT_PATH" << 'EOF'
          #!/bin/sh
          set -e

          echo "[CP] Embed Pods Frameworks (no-op in CI)"

          # Xcode 16 샌드박스 때문에 rsync로 프로젝트 전체를 복사하지 않도록,
          # 이 스크립트는 아무 것도 하지 않는다.
          # Pods는 static 링크되어 있으므로 별도 embed가 필요하지 않다.
          exit 0
          EOF

          chmod +x "$SCRIPT_PATH"


      - name: Detect Xcode scheme automatically
        id: detect_scheme
        working-directory: ios
        run: |
          set -euo pipefail
          SCHEME=InferenceExample
          echo "Detected scheme: $SCHEME"
          echo "SCHEME=$SCHEME" >> $GITHUB_ENV

      - name: Build archive (unsigned)
        working-directory: ios
        run: |
          set -euo pipefail
          echo "Using scheme: $SCHEME"

          xcodebuild \
            -workspace InferenceExample.xcworkspace \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Create unsigned IPA
        working-directory: ios
        run: |
          set -euo pipefail
          APP_NAME="$SCHEME"
          APP_PATH="build/App.xcarchive/Products/Applications/${APP_NAME}.app"
          IPA_NAME="${APP_NAME}-unsigned"

          if [ ! -d "$APP_PATH" ]; then
            echo "❌ App path not found: $APP_PATH"
            ls -R build || true
            exit 1
          fi

          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          zip -r "$IPA_NAME.ipa" Payload

          echo "Created IPA: $IPA_NAME.ipa"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-llm-unsigned-ipa
          path: ios/*.ipa
